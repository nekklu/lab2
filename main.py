import re
import sys
from typing import List, Optional
import requests


# Этап 1: "Мягкое" регулярное выражение для поиска кандидатов.
# Ищет любую последовательность, содержащую ровно 16 цифр,
# которые могут быть разделены пробелами или дефисами.
CARD_PATTERN = re.compile(r'\b\d(?:[\s-]?\d){15}\b')

# Этап 2: Паттерн для строгой проверки префиксов уже очищенного номера.
PREFIX_PATTERN = re.compile(r'^(?:4|5[1-5]|220[0-4])')

def luhn_validate(card_number: str) -> bool:
    """
    Проверяет валидность номера карты по алгоритму Луна (mod 10).

    Алгоритм работает следующим образом:
    1. Удаляются все нечисловые символы.
    2. Цифры номера обрабатываются справа налево.
    3. Каждая вторая цифра удваивается. Если результат > 9, из него вычитается 9.
    4. Все полученные цифры (измененные и неизмененные) суммируются.
    5. Если сумма кратна 10, номер считается валидным.

    Args:
        card_number: Строка с номером карты для проверки.

    Returns:
        True, если номер карты валиден, иначе False.
    """
    # Шаг 1: Очистка номера от всех нечисловых символов.
    digits_str = "".join(filter(str.isdigit, card_number))

    # Проверка на стандартную длину. Позже можно будет расширить.
    if len(digits_str) != 16:
        return False

    digits = [int(d) for d in digits_str]
    
    # Шаг 2 и 3: Удвоение каждой второй цифры, начиная с предпоследней.
    for i in range(len(digits) - 2, -1, -2):
        doubled_digit = digits[i] * 2
        if doubled_digit > 9:
            doubled_digit -= 9
        digits[i] = doubled_digit

    # Шаг 4 и 5: Суммирование и проверка.
    total = sum(digits)
    return total % 10 == 0


def find_and_validate_card_numbers(text: str) -> List[str]:
    """
    Находит в тексте все потенциальные номера карт и валидирует их.

    Args:
        text: Текст для поиска.

    Returns:
        Список уникальных валидных номеров карт (без разделителей).
    """
    # Находим все строки, которые соответствуют нашему шаблону.
    potential_numbers = CARD_PATTERN.findall(text)
    
    valid_numbers = []
    for num in potential_numbers:
        # Валидируем каждый найденный номер с помощью алгоритма Луна.
        if luhn_validate(num):
            # Если номер валиден, очищаем его от разделителей и добавляем в список.
            cleaned_num = re.sub(r'[\s-]', '', num)
            valid_numbers.append(cleaned_num)

    # Возвращаем только уникальные номера.
    return list(set(valid_numbers))


# Точка входа в программу при запуске файла напрямую.
# Используется для демонстрации и первичной отладки.
if __name__ == '__main__':
    # Тестовый текст, содержащий разные форматы номеров:
    # - один валидный номер без разделителей
    # - один валидный номер с пробелами
    # - один невалидный номер
    # - текст-заглушка
    sample_text = """
    Это тестовый текст для проверки работы парсера.
    Вот валидный номер карты Visa: 4556789012345670.
    А вот валидный номер Mastercard, записанный с пробелами: 5432 1098 7654 3210.
    Это невалидный номер карты: 1234-5678-9012-3456.
    Просто набор цифр: 987654321.
    """

    print("--- Поиск валидных номеров карт в тексте ---")
    print("Анализируемый текст:")
    print(sample_text)
    
    found_cards = find_and_validate_card_numbers(sample_text)

    if found_cards:
        print("\nНайдены следующие валидные номера:")
        for card in found_cards:
            print(f"- {card}")
    else:
        print("\nВалидные номера карт не найдены.")